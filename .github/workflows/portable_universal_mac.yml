name: build portable universal macos

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: "Python version (example: 3.12.6)"
        required: true
        default: "3.12.6"

jobs:
  build-universal-python:
    runs-on: macos-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set Python version
        run: echo "PY_VERSION=${{ github.event.inputs.python_version }}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          brew update
          brew install openssl@3 ca-certificates readline zlib bzip2 sqlite xz gdbm tcl-tk

      - name: Download Python source
        run: |
          curl -LO "https://www.python.org/ftp/python/${PY_VERSION}/Python-${PY_VERSION}.tgz"
          tar -xzf "Python-${PY_VERSION}.tgz"
          mv "Python-${PY_VERSION}" python-src

      ####################################################
      #                ARM64 BUILD
      ####################################################
      - name: Configure arm64
        working-directory: python-src
        run: |
          mkdir build-arm64
          cd build-arm64

          OPENSSL_PREFIX="$(brew --prefix openssl@3)"

          export CFLAGS="-arch arm64 -I$OPENSSL_PREFIX/include"
          export CPPFLAGS="-I$OPENSSL_PREFIX/include"
          export LDFLAGS="-arch arm64 -L$OPENSSL_PREFIX/lib"
          export MACOSX_DEPLOYMENT_TARGET=11.0

          ../configure \
            --prefix=$PWD/install \
            --enable-optimizations \
            --with-openssl="$OPENSSL_PREFIX" \
            --with-openssl-rpath=auto

      - name: Build arm64
        working-directory: python-src/build-arm64
        run: |
          make -j"$(sysctl -n hw.ncpu)"
          make install

      ####################################################
      #                X86_64 BUILD
      ####################################################
      - name: Configure x86_64
        working-directory: python-src
        run: |
          mkdir build-x86_64
          cd build-x86_64

          OPENSSL_PREFIX="$(brew --prefix openssl@3)"

          export CFLAGS="-arch x86_64 -I$OPENSSL_PREFIX/include"
          export CPPFLAGS="-I$OPENSSL_PREFIX/include"
          export LDFLAGS="-arch x86_64 -L$OPENSSL_PREFIX/lib"
          export MACOSX_DEPLOYMENT_TARGET=10.9

          ../configure \
            --prefix=$PWD/install \
            --enable-optimizations \
            --with-openssl="$OPENSSL_PREFIX" \
            --with-openssl-rpath=auto

      - name: Build x86_64
        working-directory: python-src/build-x86_64
        run: |
          make -j"$(sysctl -n hw.ncpu)"
          make install

      ####################################################
      #         Create Universal2 Python Binary
      ####################################################
      - name: Merge universal2 binaries
        working-directory: python-src
        run: |
          mkdir -p universal2
          cp -R build-arm64/install/ universal2/

          find build-arm64/install -type f | while read f; do
            rel="${f#build-arm64/install/}"
            f_arm="build-arm64/install/$rel"
            f_x86="build-x86_64/install/$rel"
            f_out="universal2/$rel"

            if [[ -f "$f_x86" ]]; then
              if file "$f_arm" | grep -q "Mach-O"; then
                lipo -create "$f_arm" "$f_x86" -output "$f_out"
              fi
            fi
          done

      ####################################################
      #              Install pip in Universal2
      ####################################################
      - name: Bootstrap pip into Universal2 Python
        working-directory: python-src/universal2
        run: |
          ./bin/python3 -m ensurepip --default-pip || true
          ./bin/python3 -m pip install --upgrade pip setuptools wheel

      ####################################################
      #       Add SSL Certificate Bundle (Fix HTTPS)
      ####################################################
      - name: Add SSL certificates
        working-directory: python-src/universal2
        run: |
          CERT_SRC="$(brew --prefix ca-certificates)/etc/ca-certificates/cert.pem"

          echo "Using certificate: $CERT_SRC"

          if [[ ! -f "$CERT_SRC" ]]; then
            echo "CA certificate bundle not found!"
            ls -R "$(brew --prefix ca-certificates)/etc"
            exit 1
          fi

          mkdir -p ./ssl
          cp "$CERT_SRC" ./ssl/cert.pem

          echo "export SSL_CERT_FILE=$(pwd)/ssl/cert.pem" >> ./bin/activate

          # Automatically load it in Python
          PYVER=$(./bin/python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          SITEPKG="./lib/python${PYVER}/site-packages"

          mkdir -p "$SITEPKG"

          echo "import os; os.environ.setdefault('SSL_CERT_FILE', r'$(pwd)/ssl/cert.pem')" \
            > "$SITEPKG/_cert_fix.py"

          echo "import _cert_fix" >> "$SITEPKG/sitecustomize.py"

      ####################################################
      #                PACKAGE RESULT
      ####################################################
      - name: Package Universal2 Python
        working-directory: python-src
        run: |
          tar -czf python-${PY_VERSION}-macos-universal2.tar.gz universal2

      - name: Move archive to workspace root
        run: mv "python-src/python-${PY_VERSION}-macos-universal2.tar.gz" .

      ####################################################
      #            PUBLISH RELEASE
      ####################################################
      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.python_version }}
          name: "Portable Python ${{ github.event.inputs.python_version }}"
          body: |
            Portable Python built as a macOS universal2 binary.
            Supports both Intel (x86_64) and Apple Silicon (arm64).
            HTTPS & pip fully working with system SSL certificates.
          files: python-${{ github.event.inputs.python_version }}-macos-universal2.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
